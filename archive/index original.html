<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Ghost City v20 (Help System)</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script> window.mapboxgl = maplibregl; </script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden;}
        
        /* LEFT SIDEBAR */
        #sidebar {
            width: 250px; background: #2c3e50; color: white; padding: 20px;
            display: flex; flex-direction: column; gap: 12px; z-index: 2000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        /* RIGHT HELP SIDEBAR (Hidden by default) */
        #help-panel {
            position: absolute; top: 0; right: 0; bottom: 0; width: 300px;
            background: white; z-index: 3000;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            padding: 25px; overflow-y: auto;
            transform: translateX(100%); /* Hide off-screen */
            transition: transform 0.3s ease-in-out;
        }
        #help-panel.open { transform: translateX(0); /* Slide in */ }

        /* CONTENT STYLING */
        #map { flex-grow: 1; position: relative; background-color: #e5e5e5; }
        
        h2 { margin-top: 0; }
        h4 { margin-bottom: 5px; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        ul { padding-left: 20px; font-size: 13px; color: #555; line-height: 1.5; }
        li { margin-bottom: 5px; }

        /* BUTTONS */
        button {
            padding: 12px; border: none; border-radius: 6px; font-size: 14px;
            cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-select { background-color: #34495e; color: white; border: 1px solid #4a6278; }
        .btn-select:hover { background-color: #415b76; }
        .btn-highway { background-color: #F9D462; color: #333; }
        .btn-street { background-color: #ecf0f1; color: #333; }
        .btn-delete { background-color: #e74c3c; color: white; margin-top: 10px; }
        .btn-save { background-color: #27ae60; color: white; margin-top: auto;}
        .btn-load { background-color: #3498db; color: white; }
        .btn-help { background-color: #95a5a6; color: white; margin-top: 10px; }
        
        .toggle-container {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; margin-top: 10px;
        }
        
        /* Close button in help panel */
        .close-btn { 
            background: none; border: none; font-size: 20px; cursor: pointer; 
            position: absolute; top: 15px; right: 15px; color: #999;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="margin:0;">Ghost City</h2>
    <p style="color:#bdc3c7; font-size:12px; margin-bottom:15px;">v20: Help System</p>
    
    <button class="btn-select" onclick="enterSelectMode()">
        <span>üëÜ</span> Select / Edit
    </button>
    
    <div style="height:10px;"></div>

    <button class="btn-highway" onclick="startDrawing('highway')">
        <span>üõ£Ô∏è</span> Draw Highway
    </button>
    
    <button class="btn-street" onclick="startDrawing('street')">
        <span>üèòÔ∏è</span> Draw Street
    </button>
    
    <div class="toggle-container">
        <input type="checkbox" id="smooth-toggle" style="width:20px; height:20px;">
        <label for="smooth-toggle">Auto-Smooth</label>
    </div>

    <button class="btn-delete" onclick="smartDelete()">
        <span>üóëÔ∏è</span> Delete (Point/Road)
    </button>

    <button class="btn-help" onclick="toggleHelp()">
        <span>‚ùì</span> How to Use
    </button>

    <div style="flex-grow:1;"></div>

    <button class="btn-save" onclick="downloadMap()">üíæ Save Map</button>
    <button class="btn-load" onclick="document.getElementById('file-input').click()">üìÇ Load Map</button>
    <input type="file" id="file-input" style="display:none" onchange="loadMap(this)" accept=".geojson,.json" />
</div>

<div id="help-panel">
    <button class="close-btn" onclick="toggleHelp()">‚úñ</button>
    <h2>User Guide</h2>
    
    <h4>1. Drawing Roads</h4>
    <ul>
        <li>Click <strong>Highway</strong> (Yellow) or <strong>Street</strong> (White).</li>
        <li>Click on the map to place points.</li>
        <li>Double-click to finish the line.</li>
        <li><strong>Auto-Smooth</strong> will curve the line automatically.</li>
    </ul>

    <h4>2. Editing Shapes</h4>
    <ul>
        <li>Click <strong>Select / Edit</strong>.</li>
        <li>Click any road to select it (turns Orange).</li>
        <li><strong>Move:</strong> Drag the white dots.</li>
        <li><strong>Add Point:</strong> Click the faint blue dots between the white ones.</li>
    </ul>

    <h4>3. Deleting</h4>
    <ul>
        <li><strong>Delete Road:</strong> Select a road, then press Delete (or click the trash button).</li>
        <li><strong>Delete Point:</strong> Click a specific white dot (it turns Red), then press Delete.</li>
    </ul>

    <h4>4. Navigation</h4>
    <ul>
        <li><strong>Zoom:</strong> Scroll wheel or +/- buttons.</li>
        <li><strong>Tilt/Rotate:</strong> Hold Right-Click and drag.</li>
        <li><strong>Reset:</strong> Click the Compass icon (top right).</li>
    </ul>
    
    <h4>5. Tips</h4>
    <ul>
        <li>Highways always appear "above" streets.</li>
        <li>Turn off "Auto-Smooth" if you want sharp corners.</li>
    </ul>
</div>

<div id="map"></div>

<script>
    let currentRoadType = 'highway'; 

    var map = new maplibregl.Map({
        container: 'map', center: [0, 0], zoom: 14,
        style: {
            "version": 8, "name": "Blank", "sources": {},
            "layers": [{ "id": "background", "type": "background", "paint": { "background-color": "#e5e5e5" } }]
        }
    });

    // --- NAV CONTROLS ---
    var nav = new maplibregl.NavigationControl({ showCompass: true, visualizePitch: true });
    map.addControl(nav, 'top-right');

    // --- STYLES ---
    const styles = [
        { "id": "gl-draw-polygon-and-line-midpoint", "type": "circle", "filter": ["all", ["==", "$type", "Point"], ["==", "meta", "midpoint"]], "paint": { "circle-radius": 5, "circle-color": "#3498db", "circle-opacity": 0.6 } },
        { "id": "street-border", "type": "line", "filter": ["all", ["==", "$type", "LineString"], ["!=", "active", "true"], ["==", "user_roadType", "street"]], "layout": { "line-cap": "round", "line-join": "round" }, "paint": { "line-color": "#cfcfcf", "line-width": 8 } },
        { "id": "street-fill", "type": "line", "filter": ["all", ["==", "$type", "LineString"], ["!=", "active", "true"], ["==", "user_roadType", "street"]], "layout": { "line-cap": "round", "line-join": "round" }, "paint": { "line-color": "#ffffff", "line-width": 6 } },
        { "id": "highway-border", "type": "line", "filter": ["all", ["==", "$type", "LineString"], ["!=", "active", "true"], ["==", "user_roadType", "highway"]], "layout": { "line-cap": "round", "line-join": "round" }, "paint": { "line-color": "#e6b058", "line-width": 14 } },
        { "id": "highway-fill", "type": "line", "filter": ["all", ["==", "$type", "LineString"], ["!=", "active", "true"], ["==", "user_roadType", "highway"]], "layout": { "line-cap": "round", "line-join": "round" }, "paint": { "line-color": "#F9D462", "line-width": 10 } },
        { "id": "gl-draw-line-active", "type": "line", "filter": ["all", ["==", "$type", "LineString"], ["==", "active", "true"]], "layout": { "line-cap": "round", "line-join": "round" }, "paint": { "line-color": "#FF9900", "line-width": 4 } },
        { "id": "gl-draw-vertex-inactive", "type": "circle", "filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["!=", "active", "true"]], "paint": { "circle-radius": 6, "circle-color": "#fff", "circle-stroke-color": "#000", "circle-stroke-width": 2 } },
        { "id": "gl-draw-vertex-active", "type": "circle", "filter": ["all", ["==", "meta", "vertex"], ["==", "$type", "Point"], ["==", "active", "true"]], "paint": { "circle-radius": 8, "circle-color": "#e74c3c", "circle-stroke-color": "#fff", "circle-stroke-width": 2 } }
    ];

    var draw = new MapboxDraw({ displayControlsDefault: false, userProperties: true, styles: styles });
    map.addControl(draw);

    // --- CURSOR ENFORCER ---
    map.on('mousemove', function(e) {
        if (draw.getMode() === 'draw_line_string') { map.getCanvas().style.cursor = 'crosshair'; return; }
        var featureIds = draw.getFeatureIdsAt(e.point);
        if (featureIds.length > 0) { map.getCanvas().style.cursor = 'pointer'; } 
        else { map.getCanvas().style.cursor = ''; }
    });

    // --- FUNCTIONS ---
    function toggleHelp() {
        document.getElementById('help-panel').classList.toggle('open');
    }
    
    function enterSelectMode() { draw.changeMode('simple_select'); }
    function startDrawing(type) { currentRoadType = type; draw.changeMode('draw_line_string'); }
    
    function smartDelete() {
        var selectedPoints = draw.getSelectedPoints();
        if (selectedPoints.features.length > 0) { draw.trash(); } 
        else {
            var selectedIds = draw.getSelectedIds();
            if (selectedIds.length > 0) { draw.delete(selectedIds); } else { draw.trash(); }
        }
    }
    document.addEventListener('keydown', function(e) { if (e.key === 'Delete' || e.key === 'Backspace') smartDelete(); });

    map.on('draw.selectionchange', function(e) {
        if (e.features.length > 0) {
            var featureId = e.features[0].id;
            setTimeout(() => { draw.changeMode('direct_select', { featureId: featureId }); }, 50);
        }
    });

    map.on('draw.create', updateRoute);
    map.on('draw.update', updateRoute);

    function updateRoute(e) {
        if (draw.getMode() === 'simple_select' || draw.getMode() === 'direct_select') return;
        var feature = e.features[0];
        if (feature.geometry.type !== 'LineString') return;
        if (document.getElementById('smooth-toggle').checked && feature.geometry.coordinates.length > 2) {
            draw.delete(feature.id); 
            var curved = turf.bezierSpline(feature, { resolution: 10000, sharpness: 0.85 });
            curved.properties = { roadType: currentRoadType };
            draw.add(curved);
        } else {
            draw.setFeatureProperty(feature.id, 'roadType', currentRoadType);
        }
    }

    function downloadMap() {
        var data = draw.getAll();
        if (data.features.length === 0) { alert("Map is empty!"); return; }
        var blob = new Blob([JSON.stringify(data)], {type: "application/geo+json"});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "ghost-city.geojson";
        a.click();
    }
    function loadMap(input) {
        var file = input.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var json = JSON.parse(e.target.result);
                draw.deleteAll(); draw.add(json);
                var bounds = new maplibregl.LngLatBounds();
                json.features.forEach(f => f.geometry.coordinates.forEach(c => bounds.extend(c)));
                if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 50 });
            } catch (error) { alert("Error: " + error); }
        };
        reader.readAsText(file);
        input.value = '';
    }
</script>
</body>
</html>